<html lang="en">
  <head>
    <meta charset="utf-8" />
	<link rel="icon" type="image/x-icon" href="src/img/logo.ico"/>
    <title>脱单指数测试</title>
  </head>
  <body>
    <div id='loading' class="spinner">
		<div class="dot1"></div>
		<div class="dot2"></div>
	</div>
	<div id='friend'>
	<img id='bg' src='src/img/match.jpg' style='z-index:-1;position:absolute;top:0;left:0;width:100%;height:auto;'/>
	<div id='buttons' hidden>
		<img id='male1' src='src/img/button.png' onclick="female()" style='z-index:1;position:absolute;left:35%;width:10%'/>
		<img id='male2' src='src/img/buttonred.png' hidden style='z-index:1;position:absolute;left:35%;width:10%'/>
		<img id='female1' src='src/img/button.png' onclick="male()" style='z-index:1;position:absolute;left:68%;width:10%'/>
		<img id='female2' src='src/img/buttonred.png' hidden style='z-index:1;position:absolute;left:68%;width:10%'/>
		<input id='wechat' type='text' style='z-index:1;position:absolute;left:35%;width:55%;background-color:white;border-radius:10px;border:none;padding-left:10px;padding-right:10px;font-size:50px'/>
		<img id='type1' src='src/img/button.png' onclick="type1()" style='z-index:1;position:absolute;left:44%;width:10%'/>
		<img id='type1on' src='src/img/buttonred.png' hidden style='z-index:1;position:absolute;left:44%;width:10%'/>
		<img id='type2' src='src/img/button.png' onclick="type2()" style='z-index:1;position:absolute;left:44%;width:10%'/>
		<img id='type2on' src='src/img/buttonred.png' hidden style='z-index:1;position:absolute;left:44%;width:10%'/>
		<img id='button' src='src/img/matchbutton.png' onclick="startMatch()" style='z-index:1;position:absolute;left:27.5%;width:45%'/>
	</div>
	</div>
	<div id='match' align='center' style='margin-left:5%;margin-right:5%' hidden>
	    <img src='src/img/matchres.jpg' style='z-index:-1;position:absolute;top:0;left:0;width:100%;height:auto;'/>
		<div id='matchinfo' style='z-index:1;position:absolute;left:15%;width:70%;color:white;font-size:50px'></div>
	</div>
  </body>
</html>
<style>
.spinner {
  margin: 100px auto;
  width: 90px;
  height: 90px;
  position: relative;
  text-align: center;
   
  -webkit-animation: rotate 2.0s infinite linear;
  animation: rotate 2.0s infinite linear;
}
 
.dot1, .dot2 {
  width: 60%;
  height: 60%;
  display: inline-block;
  position: absolute;
  top: 0;
  background-color: #67CF22;
  border-radius: 100%;
   
  -webkit-animation: bounce 2.0s infinite ease-in-out;
  animation: bounce 2.0s infinite ease-in-out;
}
 
.dot2 {
  top: auto;
  bottom: 0px;
  -webkit-animation-delay: -1.0s;
  animation-delay: -1.0s;
}
 
@-webkit-keyframes rotate { 100% { -webkit-transform: rotate(360deg) }}
@keyframes rotate { 100% { transform: rotate(360deg); -webkit-transform: rotate(360deg) }}
 
@-webkit-keyframes bounce {
  0%, 100% { -webkit-transform: scale(0.0) }
  50% { -webkit-transform: scale(1.0) }
}
 
@keyframes bounce {
  0%, 100% {
    transform: scale(0.0);
    -webkit-transform: scale(0.0);
  } 50% {
    transform: scale(1.0);
    -webkit-transform: scale(1.0);
  }
}
</style>
<script type="text/javascript" src="src/js/Bmob-1.6.3.min.js"></script>
<script type="text/javascript">
  if(!location.search){
    window.location.href='main.html';
  }
  var info=location.search.split('=')[1].split('&');
  var res=parseFloat(info[0]);
  var APP=parseFloat(info[1]);
  var HAP=parseFloat(info[2]);
  var INC=parseFloat(info[3]);
  var GPA=parseFloat(info[4]);
  var STFC=parseInt(info[5]);
  var timer = setInterval(function() {
		if (document.getElementById('bg').complete) {
			clearInterval(timer)
			var height=parseInt(window.getComputedStyle(document.getElementById('bg')).height)
			document.getElementById('male1').style.top=0.295*height;
			document.getElementById('male2').style.top=0.295*height;
			document.getElementById('female1').style.top=0.295*height;
			document.getElementById('female2').style.top=0.295*height;
			
			document.getElementById('wechat').style.top=0.385*height;
			document.getElementById('wechat').style.height=height*100/2135;
			document.getElementById('wechat').style.lineHeight=height*100/2135;
			
			document.getElementById('type1').style.top=0.46*height;
			document.getElementById('type1on').style.top=0.46*height;
			document.getElementById('type2').style.top=0.55*height;
			document.getElementById('type2on').style.top=0.55*height;
			document.getElementById('button').style.top=0.64*height;
			
			document.getElementById('buttons').style.display='inline';
			document.getElementById('loading').style.visibility="hidden";
			document.getElementById('matchinfo').style.top=0.5*height;
		}
	},30)
  Bmob.initialize("7f518700e53363110974536ce2d479fb", "a7bdd090a38a53c3487cb57c00e6cd8f");
  var sex,type,wechat;
  function female(){
    sex='女';
    document.getElementById('male1').style.display='none';
	document.getElementById('male2').style.display='inline';
	document.getElementById('female2').style.display='none';
	document.getElementById('female1').style.display='inline';
  }
  function male(){
    sex='男';
    document.getElementById('female1').style.display='none';
	document.getElementById('female2').style.display='inline';
	document.getElementById('male2').style.display='none';
	document.getElementById('male1').style.display='inline';
  }
  function type1(){
    type=1;
    document.getElementById('type1').style.display='none';
	document.getElementById('type1on').style.display='inline';
	document.getElementById('type2on').style.display='none';
	document.getElementById('type2').style.display='inline';
  }
  function type2(){
    type=0;
    document.getElementById('type2').style.display='none';
	document.getElementById('type2on').style.display='inline';
	document.getElementById('type1on').style.display='none';
	document.getElementById('type1').style.display='inline';
  }
  function startMatch(){  //脱单匹配函数
    wechat=document.getElementById('wechat').value;
	if(sex==undefined){
	  alert("请选择您的性别！")
	}
	else if(!wechat){
	  alert("请输入您的微信号！")
	}
	else if(type==undefined){
	  alert("请选择您要匹配的类型！")
	}
	else{
	  document.getElementById('friend').style.display='none';
	  document.getElementById('loading').style.visibility="visible";
	  if(type=='1'){
	    var query = Bmob.Query("test");
		query.equalTo("sex","==", (sex=='男'?'女':'男'));
		query.equalTo("num","<", 3);
		query.order("-res");
		query.limit(1);
		query.find().then(res => {
		    document.getElementById('loading').style.visibility="hidden";
		    document.getElementById('match').style.display="inline";
			if(!res.length){
				document.getElementById('matchinfo').innerHTML="暂时没有人了鸭，等一等可能会有有缘人联系你哦！"
			}
			else{
				document.getElementById('matchinfo').innerHTML="经过匹配，您最有缘的对象的微信号是："+res[0].wechat+"，"+(sex=='男'?'她':'他')+"的脱单指数是："+res[0].res.toFixed(3)+"，快去联系"+(sex=='男'?'她':'他')+"吧！"
				var query = Bmob.Query('test');
				query.get(res[0].objectId).then(res => {
					res.set('num',res.num+1)
					res.save()
				}).catch(err => {
					console.log(err)
				})
			}
		});
	  }
	  else if(type=='0'){
	    var query = Bmob.Query("test");
		query.equalTo("sex","==", (sex=='男'?'女':'男'));
		query.equalTo("num","<", 3);
		query.order("-res");
		query.limit(1000);
		query.find().then(results => {
			if(!results.length){
				document.getElementById('loading').style.visibility="hidden";
				document.getElementById('match').style.display="inline";
				document.getElementById('matchinfo').innerHTML="暂时没有人了鸭，等一等可能会有有缘人联系你哦！"
			}
		    else if(res>=results[0].res){
			    document.getElementById('loading').style.visibility="hidden";
				document.getElementById('match').style.display="inline";
				document.getElementById('matchinfo').innerHTML="经过匹配，您最有缘的对象的微信号是："+results[0].wechat+"，"+(sex=='男'?'她':'他')+"的脱单指数是："+results[0].res.toFixed(3)+"，快去联系"+(sex=='男'?'她':'他')+"吧！"
				var query = Bmob.Query('test');
				query.get(results[0].objectId).then(res => {
					res.set('num',res.num+1)
					res.save()
				}).catch(err => {
					console.log(err)
				})
			}
			else if(res<=results[results.length-1].res){
			    document.getElementById('loading').style.visibility="hidden";
				document.getElementById('match').style.display="inline";
				document.getElementById('matchinfo').innerHTML="经过匹配，您最有缘的对象的微信号是："+results[results.length-1].wechat+"，"+(sex=='男'?'她':'他')+"的脱单指数是："+results[results.length-1].res.toFixed(3)+"，快去联系"+(sex=='男'?'她':'他')+"吧！"
				var query = Bmob.Query('test');
				query.get(results[results.length-1].objectId).then(res => {
					res.set('num',res.num+1)
					res.save()
				}).catch(err => {
					console.log(err)
				})
			}
			else{
				for(var i=0;i<results.length-1;i++){
					if(results[i].res>=res&&results[i+1].res<=res){
						if((results[i].res-res)<=(res-results[i+1].res)){
							document.getElementById('loading').style.visibility="hidden";
							document.getElementById('match').style.display="inline";
							document.getElementById('matchinfo').innerHTML="经过匹配，您最有缘的对象的微信号是："+results[i].wechat+"，"+(sex=='男'?'她':'他')+"的脱单指数是："+results[i].res.toFixed(3)+"，快去联系"+(sex=='男'?'她':'他')+"吧！"
							var query = Bmob.Query('test');
							query.get(results[i].objectId).then(res => {
								res.set('num',res.num+1)
								res.save()
							}).catch(err => {
								console.log(err)
							})
						}
						else{
							document.getElementById('loading').style.visibility="hidden";
							document.getElementById('match').style.display="inline";
							document.getElementById('matchinfo').innerHTML="经过匹配，您最有缘的对象的微信号是："+results[i+1].wechat+"，"+(sex=='男'?'她':'他')+"的脱单指数是："+results[i+1].res.toFixed(3)+"，快去联系"+(sex=='男'?'她':'他')+"吧！"
							var query = Bmob.Query('test');
							query.get(results[i+1].objectId).then(res => {
								res.set('num',res.num+1)
								res.save()
							}).catch(err => {
								console.log(err)
							})
						}
						break;
					}
				}
			}
		});
	  }
	  var query = Bmob.Query('test');
	  query.set("APP",APP)
	  query.set("HAP",HAP)
	  query.set("INC",INC)
	  query.set("GPA",GPA)
	  query.set("STFC",STFC)
	  query.set("res",res)
	  query.set("sex",sex)
	  query.set("wechat",wechat)
	  query.set("num",0)
	  query.save().then(res => {
	    console.log(res)
	  }).catch(err => {
        console.log(err)
	  })
	}
  }
</script>